# 多用户隔离功能测试指南

## 🧪 快速测试步骤

### 测试 1：单用户数据隔离

1. **启动应用**：
   ```bash
   python app.py
   ```

2. **浏览器 A（Chrome）**：
   - 打开 http://127.0.0.1:5001
   - 上传 2 份 PDF
   - 记下显示的简历数量：应该是 2

3. **浏览器 B（Firefox / 无痕模式）**：
   - 打开 http://127.0.0.1:5001
   - 上传 3 份 PDF
   - 记下显示的简历数量：应该是 3
   - **注意**：不应该看到浏览器 A 上传的 2 份

4. **回到浏览器 A**：
   - 刷新页面
   - 仍然只能看到自己的 2 份简历 ✅

### 测试 2：Session 持久化

1. **上传数据**：
   - 在浏览器中上传 PDF
   - 确认数据显示正常

2. **刷新页面**：
   - 按 F5 或刷新按钮
   - 数据应该还在 ✅

3. **新标签页**：
   - 在同一浏览器打开新标签页
   - 访问 http://127.0.0.1:5001
   - 应该看到相同的数据 ✅

4. **关闭浏览器重新打开**：
   - 完全关闭浏览器
   - 重新打开并访问
   - 数据应该还在（1小时内）✅

### 测试 3：数据自动清理

**方法 1：快速测试（修改代码）**

临时修改 `app.py` 中的清理时间：

```python
# 改为1分钟清理（仅测试用）
db.clean_expired_data(hours=1/60)  # 1分钟 = 1/60小时
```

重启应用，等待1分钟后刷新，数据应该消失。

**方法 2：正常测试（等待1小时）**

1. 上传测试数据
2. 等待 1 小时零几分钟
3. 刷新页面，数据应该自动清理 ✅

### 测试 4：清空功能

1. **上传数据**：
   - 上传几份 PDF

2. **点击"清空数据库"**：
   - 点击清空按钮
   - 确认操作

3. **验证结果**：
   - 当前用户数据应该清空 ✅
   - 切换到其他浏览器（其他用户）
   - 其他用户的数据不应该被清空 ✅

## 🔍 详细测试场景

### 场景 1：多用户并发使用

**目标**：验证数据隔离

1. 准备 3 个不同浏览器（Chrome, Firefox, Safari）或使用无痕模式
2. 同时在 3 个浏览器中打开应用
3. 每个浏览器上传不同数量的 PDF（如 1份、2份、3份）
4. 验证每个浏览器只能看到自己的数据

**预期结果**：
- Chrome: 显示 1 份简历
- Firefox: 显示 2 份简历
- Safari: 显示 3 份简历
- 互不干扰 ✅

### 场景 2：Session 过期测试

**目标**：验证 Session 过期后无法访问旧数据

1. 上传数据
2. 清除浏览器 Cookie（或使用无痕模式）
3. 重新访问应用
4. 之前的数据应该看不到（新的 Session ID）

**预期结果**：
- 清除 Cookie 前：可以看到数据
- 清除 Cookie 后：无法看到旧数据（新用户）✅
- 旧数据会在1小时后被自动清理 ✅

### 场景 3：后台清理任务

**目标**：验证定时任务正常运行

1. 启动应用，观察控制台输出：
   ```
   简历信息提取系统（线上版）已启动
   💡 用户数据隔离已启用，数据将在1小时后自动清理
   ```

2. 查看日志中定时任务的执行（每10分钟）

3. 可以手动触发清理测试：
   ```python
   # 在 Python shell 中
   from database import ResumeDatabase
   db = ResumeDatabase()
   deleted = db.clean_expired_data(hours=1)
   print(f"清理了 {deleted} 条过期记录")
   ```

## 🐛 常见问题排查

### 问题 1：所有用户看到相同的数据

**可能原因**：Session 配置有问题

**检查**：
```python
# 确认 app.py 中有以下配置
app.config['SECRET_KEY'] = ...
```

**解决**：确保 SECRET_KEY 已配置

### 问题 2：刷新页面后数据丢失

**可能原因**：Session 没有持久化

**检查**：
```python
# 确认有这行代码
session.permanent = True
```

**解决**：确保设置了 permanent session

### 问题 3：数据没有自动清理

**可能原因**：后台任务没有启动

**检查**：
```python
# 确认这段代码存在
scheduler = BackgroundScheduler()
scheduler.start()
```

**解决**：确保 APScheduler 已安装并启动

### 问题 4：APScheduler 报错

**错误信息**：
```
ModuleNotFoundError: No module named 'apscheduler'
```

**解决**：
```bash
pip install APScheduler
# 或
pip install -r requirements-compatible.txt
```

## 📊 数据库验证

### 查看数据库内容

```bash
sqlite3 resumes.db
```

```sql
-- 查看所有记录（包含 session_id）
SELECT id, session_id, filename, created_at FROM resumes;

-- 统计每个用户的数据量
SELECT session_id, COUNT(*) as count 
FROM resumes 
GROUP BY session_id;

-- 查看过期数据
SELECT * FROM resumes 
WHERE created_at < datetime('now', '-1 hour');

-- 手动清理过期数据
DELETE FROM resumes 
WHERE created_at < datetime('now', '-1 hour');
```

## ✅ 测试检查清单

使用此清单确保所有功能正常：

- [ ] 单个用户可以正常上传和查看数据
- [ ] 多个用户的数据完全隔离
- [ ] 刷新页面后数据仍然存在
- [ ] 新标签页可以看到相同数据
- [ ] 清除 Cookie 后变成新用户
- [ ] "清空数据库"只清空当前用户数据
- [ ] 后台任务正常启动（控制台有提示）
- [ ] 1小时后数据自动清理（长期测试）
- [ ] 数据库中有 session_id 字段
- [ ] 邮箱列表正确显示（只显示当前用户的）

## 🚀 性能测试（可选）

### 测试并发性能

```bash
# 使用 Apache Bench 测试
ab -n 100 -c 10 http://127.0.0.1:5001/

# 查看响应时间和并发处理能力
```

### 测试大数据量

1. 上传 100+ 份简历
2. 查看页面加载速度
3. 检查数据库查询性能

## 📝 报告模板

测试完成后，可以使用以下模板记录结果：

```
测试日期：2025-10-31
测试人员：[您的名字]
环境：Python 3.x, Flask x.x

【功能测试】
✅ 数据隔离：通过
✅ Session 持久化：通过
✅ 自动清理：通过
✅ 清空功能：通过

【性能测试】
- 并发用户：10
- 响应时间：<100ms
- 数据库大小：xxx MB

【问题记录】
无 / [记录遇到的问题]

【建议】
[改进建议]
```

---

**祝测试顺利！** 🎉

如有问题，请查看 `多用户隔离说明.md` 了解技术细节。

